<script setup lang="ts">
import { Filter, Search as SearchIcon, Plus, ChevronLeft, ChevronRight } from 'lucide-vue-next'
import { calendarEvents, eventTypeConfig, getEventsForDate, getEventTypeColor } from '~/utils/mockCalendar'

definePageMeta({
  layout: 'default'
})

// Calendar state
const currentDate = ref(new Date(2024, 11, 1)) // December 2024
const searchQuery = ref('')

// Calendar grid generation
const weekDays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat']

const calendarDays = computed(() => {
  const year = currentDate.value.getFullYear()
  const month = currentDate.value.getMonth()

  // Get first day of month and number of days
  const firstDay = new Date(year, month, 1)
  const lastDay = new Date(year, month + 1, 0)
  const daysInMonth = lastDay.getDate()
  const startDayOfWeek = firstDay.getDay()

  // Get previous month's last days
  const prevMonthLastDay = new Date(year, month, 0).getDate()
  const prevMonthDays = startDayOfWeek

  // Get next month's first days
  const totalCells = Math.ceil((daysInMonth + startDayOfWeek) / 7) * 7
  const nextMonthDays = totalCells - (daysInMonth + startDayOfWeek)

  const days = []

  // Previous month days
  for (let i = prevMonthDays - 1; i >= 0; i--) {
    const date = new Date(year, month - 1, prevMonthLastDay - i)
    days.push({
      date,
      day: date.getDate(),
      isCurrentMonth: false,
      events: getEventsForDate(date)
    })
  }

  // Current month days
  for (let i = 1; i <= daysInMonth; i++) {
    const date = new Date(year, month, i)
    days.push({
      date,
      day: i,
      isCurrentMonth: true,
      events: getEventsForDate(date)
    })
  }

  // Next month days
  for (let i = 1; i <= nextMonthDays; i++) {
    const date = new Date(year, month + 1, i)
    days.push({
      date,
      day: i,
      isCurrentMonth: false,
      events: getEventsForDate(date)
    })
  }

  return days
})

const currentMonthName = computed(() => {
  return currentDate.value.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })
})

function previousMonth() {
  currentDate.value = new Date(currentDate.value.getFullYear(), currentDate.value.getMonth() - 1, 1)
}

function nextMonth() {
  currentDate.value = new Date(currentDate.value.getFullYear(), currentDate.value.getMonth() + 1, 1)
}

function goToToday() {
  currentDate.value = new Date()
}
</script>

<template>
  <SidebarProvider>
    <Sidebar collapsible="icon" variant="sidebar" side="left">
      <SidebarHeader>
        <SidebarMenu>
          <SidebarMenuItem>
            <SidebarMenuButton size="lg" as-child>
              <a href="#">
                <div class="flex aspect-square size-8 items-center justify-center rounded-md bg-black text-white">
                  <span class="font-bold text-sm">HC</span>
                </div>
                <div class="grid flex-1 text-left text-sm leading-tight">
                  <span class="truncate font-semibold">HomeComing 2.0</span>
                </div>
              </a>
            </SidebarMenuButton>
          </SidebarMenuItem>
        </SidebarMenu>
      </SidebarHeader>

      <SidebarContent>
        <SidebarGroup>
          <SidebarGroupLabel>Navigation</SidebarGroupLabel>
          <SidebarGroupContent>
            <SidebarMenu>
              <SidebarMenuItem v-for="item in navigationItems" :key="item.title">
                <SidebarMenuButton as-child>
                  <a :href="item.url">
                    <component :is="item.icon" />
                    <span>{{ item.title }}</span>
                  </a>
                </SidebarMenuButton>
              </SidebarMenuItem>
            </SidebarMenu>
          </SidebarGroupContent>
        </SidebarGroup>

        <SidebarGroup>
          <SidebarGroupLabel>Tour Logistics</SidebarGroupLabel>
          <SidebarGroupContent>
            <SidebarMenu>
              <SidebarMenuItem v-for="item in logisticsItems" :key="item.title">
                <SidebarMenuButton as-child>
                  <a :href="item.url">
                    <component :is="item.icon" />
                    <span>{{ item.title }}</span>
                  </a>
                </SidebarMenuButton>
              </SidebarMenuItem>
            </SidebarMenu>
          </SidebarGroupContent>
        </SidebarGroup>
      </SidebarContent>

      <SidebarFooter>
        <SidebarMenu>
          <SidebarMenuItem>
            <SidebarMenuButton size="lg" as-child>
              <a href="#">
                <Avatar class="h-8 w-8 rounded-lg">
                  <AvatarImage src="/avatars/user.jpg" alt="User" />
                  <AvatarFallback class="rounded-lg">TM</AvatarFallback>
                </Avatar>
                <div class="grid flex-1 text-left text-sm leading-tight">
                  <span class="truncate font-semibold">Tour Manager</span>
                  <span class="truncate text-xs">manager@homecoming.com</span>
                </div>
                <ChevronsUpDown class="ml-auto size-4" />
              </a>
            </SidebarMenuButton>
          </SidebarMenuItem>
        </SidebarMenu>
      </SidebarFooter>
    </Sidebar>

    <SidebarInset>
      <header class="flex h-16 shrink-0 items-center gap-2 transition-[width,height] ease-linear group-has-[[data-collapsible=icon]]/sidebar-wrapper:h-12">
        <div class="flex items-center gap-2 px-4">
          <SidebarTrigger class="-ml-1" />
          <Separator orientation="vertical" class="mr-2 h-4" />
        </div>
      </header>

      <div class="flex flex-1 flex-col gap-4 p-6 pt-0 bg-gray-50">
        <div class="flex items-center justify-between mb-4">
          <h1 class="text-3xl font-bold text-gray-900">Calendar</h1>
          <div class="flex items-center gap-2">
            <Button variant="outline" size="sm">
              <Filter class="h-4 w-4 mr-2" />
              Filter
            </Button>
            <div class="relative">
              <SearchIcon class="absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground" />
              <Input
                v-model="searchQuery"
                type="search"
                placeholder="Search Shows"
                class="pl-9 w-64"
              />
            </div>
            <Button size="sm" class="bg-black text-white hover:bg-black/90" as-child>
              <a href="/events/add">
                <Plus class="h-4 w-4 mr-2" />
                Add Event
              </a>
            </Button>
          </div>
        </div>
        <!-- Calendar Controls -->
        <div class="flex items-center justify-center gap-4 mb-6">
          <Button variant="ghost" size="icon" @click="previousMonth">
            <ChevronLeft class="h-5 w-5" />
          </Button>
          <Button variant="outline" size="sm" @click="goToToday">
            Today
          </Button>
          <Button variant="ghost" size="icon" @click="nextMonth">
            <ChevronRight class="h-5 w-5" />
          </Button>
          <DropdownMenu>
            <DropdownMenuTrigger as-child>
              <Button variant="outline" size="sm">
                {{ currentMonthName }}
                <ChevronsUpDown class="ml-2 h-4 w-4" />
              </Button>
            </DropdownMenuTrigger>
            <DropdownMenuContent>
              <DropdownMenuItem>January 2024</DropdownMenuItem>
              <DropdownMenuItem>February 2024</DropdownMenuItem>
              <DropdownMenuItem>March 2024</DropdownMenuItem>
              <DropdownMenuItem>April 2024</DropdownMenuItem>
              <DropdownMenuItem>May 2024</DropdownMenuItem>
              <DropdownMenuItem>June 2024</DropdownMenuItem>
              <DropdownMenuItem>July 2024</DropdownMenuItem>
              <DropdownMenuItem>August 2024</DropdownMenuItem>
              <DropdownMenuItem>September 2024</DropdownMenuItem>
              <DropdownMenuItem>October 2024</DropdownMenuItem>
              <DropdownMenuItem>November 2024</DropdownMenuItem>
              <DropdownMenuItem>December 2024</DropdownMenuItem>
            </DropdownMenuContent>
          </DropdownMenu>
        </div>

        <!-- Calendar Grid -->
        <div class="bg-white rounded-lg border overflow-hidden">
          <!-- Week headers -->
          <div class="grid grid-cols-7 border-b bg-muted/50">
            <div
              v-for="day in weekDays"
              :key="day"
              class="p-3 text-center text-sm font-semibold"
            >
              {{ day }}
            </div>
          </div>

          <!-- Calendar days -->
          <div class="grid grid-cols-7">
            <div
              v-for="(dayData, index) in calendarDays"
              :key="index"
              class="min-h-[120px] border-r border-b p-2 relative"
              :class="{
                'bg-muted/20': !dayData.isCurrentMonth
              }"
            >
              <div
                class="text-sm font-medium mb-1"
                :class="{
                  'text-muted-foreground': !dayData.isCurrentMonth,
                  'text-foreground': dayData.isCurrentMonth
                }"
              >
                {{ dayData.day }}
              </div>
              <div class="space-y-1">
                <div
                  v-for="event in dayData.events"
                  :key="event.id"
                  class="text-xs px-2 py-1 rounded font-medium truncate"
                  :class="getEventTypeColor(event.type)"
                >
                  {{ event.title }}
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Legend -->
        <div class="flex items-center justify-center gap-6 mt-6">
          <div
            v-for="(config, type) in eventTypeConfig"
            :key="type"
            class="flex items-center gap-2"
          >
            <div
              class="w-4 h-4 rounded"
              :class="config.color"
            />
            <span class="text-sm text-muted-foreground">{{ config.label }}</span>
          </div>
        </div>
      </div>
    </SidebarInset>
  </SidebarProvider>
</template>
